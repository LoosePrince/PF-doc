# 插件兼容

## 插件配置多语言指南（支持 YAML 与 JSON）

本文档介绍如何为插件的配置项提供“标题与描述”的多语言（或单语言）信息，以便 WebUI 在表单模式下展示友好的中文/英文提示。

### 总览

- **YAML 配置**：在同一个 `.yml/.yaml` 文件中通过注释编写翻译。
- **JSON 配置**：在同目录下提供一个独立的 `*_lang.json` 翻译文件。
- **语言代码**：兼容 `zh-CN/zh_cn/zh-cn` 与 `en-US/en_us/en-us` 等多种写法，最终会被规范化为 `zh-CN`、`en-US`。
- **显示顺序**：优先使用“当前界面语言”，无则回退“默认语言”，再回退“第一个可用语言”。
- **结构化支持**：YAML 现已支持嵌套对象与数组；JSON 亦支持结构化的翻译文件（`default + translations + children`）。

---

## 一、YAML 格式

YAML 支持两种书写方案，可同时混用

如使用方案一加上方案二的的组合（如仅添加 `[en-US]` 语言块，而`[zh-CN]` 语言块不添加）。

### 方案一：同行或上一行注释（单语言/默认语言）

- 在键后添加注释，格式：`名称::描述`。
- 若同行没有注释，则使用上一行的普通注释作为该键的名称/描述。

示例：

```yaml
host: 127.0.0.1 # host::IP地址
port: 8080 # port::正向 Websocket 端口号
post_path: "" # Endpoint::host:port/Endpoint (一般不用动)
token: "" # token::QQ 的加密 token
language: zh # language::语言设置
#API 最长等待时间::单位（秒）
max_wait_time: 5
```


要点：

- `名称::描述` 二段式；若只写一个词则作为“名称”，描述留空。
- 若无语言块（见方案二），则该注释被视为“默认语言”（默认 `zh-CN`，也可通过 `language` 字段指定）。

### 方案二：语言块（多语言）

- 以注释行 `# [语言代码]` 开始一个语言块；
- 在块内使用管道格式：`# 键 | 名称::描述`（也可只有名称）。

示例：

```yaml
host: 127.0.0.1
port: 8080
post_path: ""
token: ""
language: zh
max_wait_time: 5

# [zh-CN]
# host | host::IP地址
# port | port::正向 Websocket 端口号
# post_path | Endpoint::host:port/Endpoint (一般不用动)
# token | token::QQ 的加密 token
# language | language::语言设置
# max_wait_time | API 最长等待时间::单位（秒）

# [en-US]
# host | host::IP address
# port | port::Forward Websocket port number
# post_path | Endpoint::host:port/Endpoint (usually not to be changed)
# token | token::QQ encrypted token
# language | language::Language setting
# max_wait_time | API maximum waiting time::Unit (seconds)
```

回退规则：

- 某个键在语言块里缺失时，会回退到“方案一”的同行/上一行注释。
- 默认语言顺序：`language` 字段指定 > 第一段语言块 > `zh-CN`。

### 结构化（嵌套对象与数组）

YAML 现在原生支持对“嵌套对象/数组”的结构化翻译：

- **点路径（对象子键）**：在语言块中用 `父键.子键` 指定嵌套键，例如 `# command.ban_word | 违禁词撤回::……`。
- **数组与枚举项**：
  - 对于数组本身，用 `# 数组键 | 名称::描述` 描述整体；
  - 若数组表示“枚举/选项”，可用 `数组键.选项值` 为每个选项命名，例如：
    - `# inactive_notice_option.admin | 机器人管理员`、`# inactive_notice_option.group | 监控群`；
  - 普通标量数组项不需要逐项翻译，UI 中会按整体名称展示。
- **示例**：

```yaml
command:
  ban_word: true # 违禁词撤回

# [zh-CN]
# command | 指令相关
# command.ban_word | 违禁词撤回::命中违禁词将撤回消息

inactive_notice_option:
  - "admin"
  - "group"

# [en-US]
# inactive_notice_option | Inactive Check Target
# inactive_notice_option.admin | Admin
# inactive_notice_option.group | Monitor Group
```

注意：

- 使用“点路径”可以在同一文档中区分相同的子键名（如多个对象中都存在 `name`）。
- 极端复杂/动态键名（运行期才出现的键）不建议逐项翻译，优先为“顶层键/重要子键”提供名称与描述。

---

## 二、JSON 格式

JSON 配置的翻译需要放在“同名 + `_lang.json`”文件内。例如：

- 配置文件：`config/my_plugin/config.json`
- 翻译文件：`config/my_plugin/config_lang.json`

JSON 翻译支持两种模式：

### 1）平铺模式（兼容）

顶层即为语言代码，内部是“键 → 标题/描述”。支持两种值格式：

- 数组格式：`[名称, 描述]`
- 对象格式：`{"name": 名称, "desc": 描述}`

示例：

```json
{
  "zh_cn": {
    "host": ["host", "IP地址"],
    "port": ["port", "正向 Websocket 端口号"],
    "post_path": ["Endpoint", "host:port/Endpoint (一般不用动)"],
    "token": ["token", "QQ 的加密 token"],
    "language": ["language", ""],
    "max_wait_time": ["API 最长等待时间", "单位（秒)"]
  },
  "en_us": {
    "host": ["host", "IP address"],
    "port": ["port", "Websocket port"],
    "post_path": ["Endpoint", "host:port/Endpoint"],
    "token": ["token", "QQ token"],
    "language": ["language", ""],
    "max_wait_time": ["API maximum wait time", "/second"]
  }
}
```

说明：

- 语言代码可写为 `zh-CN/zh_cn/zh-cn`、`en-US/en_us/en-us` 等，WebUI 会自动规范化。
- 若只提供一种语言，也能正常工作；其他语言将回退到该语言。
- `properties` 配置的翻译也使用相同思路：为 `xxx.properties` 提供 `xxx_lang.json`。

### 2）结构化模式（推荐，适用于嵌套对象/数组）

当配置包含较多“嵌套对象/数组/枚举项”时，建议使用结构化模式：

- 顶层包含 `default`（默认语言）与 `translations`（各语言内容）。
- 每个键为一个对象，包含 `name`、`desc` 与可选的 `children`；`children` 用于描述子键。
- 子键继续使用对象结构递归描述；也可使用“点路径”作为键名以减少嵌套层级。

示例（节选）：

```json
{
  "default": "en-US",
  "translations": {
    "en-US": {
      "command": {
        "name": "Commands",
        "desc": "Feature switches",
        "children": {
          "ban_word": { "name": "Ban Word Recall", "desc": "Recall messages that contain banned words", "children": {} }
        }
      },
      "inactive_notice_option": {
        "name": "Inactive Check Target",
        "desc": "Where to send inactive member alerts",
        "children": {
          "admin": { "name": "Admin", "desc": "Bot administrators", "children": {} },
          "group": { "name": "Monitor Group", "desc": "Monitored group", "children": {} }
        }
      }
    },
    "zh-CN": {
      "command": {
        "name": "指令相关",
        "desc": null,
        "children": { "ban_word": { "name": "违禁词撤回", "desc": null, "children": {} } }
      }
    }
  }
}
```

说明：

- `default` 控制当某语言缺失时的首选回退语言。
- `children` 用于结构化子键；也可使用“点路径”在同级上直接声明（两种写法等价，由 WebUI 解析）。
- 对“枚举选项/固定取值”的翻译可按子键处理（如 `inactive_notice_option.admin`）。

---

### 非多语言（单语言）写法建议

- YAML：仅使用“方案一”的同行/上一行注释，作为默认语言即可。
- JSON：在 `*_lang.json` 中只提供一种语言（如 `zh_cn`），或者仅提供名称、描述其中之一（描述可留空）。

现已支持嵌套结构与相同子键名的区分（通过“点路径/结构化 children”）。仍不建议对“极端复杂或动态生成的键”逐项翻译，优先保证主要配置项可读性。

## 三、html 格式

- **规则**：使用 `main.json` 文件，通过键值对指定每个配置文件对应的 `html` 文件。WebUI 加载时会自动加载对应的 `html` 内容。
- **样式与脚本**：如需自定义样式或脚本，请直接在 `html` 文件中使用 `<style>` 和 `<script>` 标签，不要使用外链方式加载本地 css 或 js 文件。

示例：

`main.json`:

```json
{
  "my_plugin_config": "my_plugin_config.html"
}
```

`my_plugin_config.html`:

```html
<div>
  <h3>自定义配置界面</h3>
  <style>
    /* 你的样式 */
  </style>
  <script>
    // 你的脚本
  </script>
  <!-- 提示：`main.json` 会被 WebUI 过滤，不会出现在配置文件列表中 -->
</div>
```